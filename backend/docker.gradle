plugins {
    id 'com.bmuschko.docker-remote-api' version '3.0.5'
}
import com.bmuschko.gradle.docker.tasks.image.DockerBuildImage
import com.bmuschko.gradle.docker.tasks.image.DockerPushImage

ext {
    image = 'docker-registry.labs.intellij.net/mkuzmin-demo/backend'
    buildNumber = System.env.BUILD_NUMBER ?: 'dev'
}

repositories {
    jcenter()
}

docker {
    url = org.gradle.internal.os.OperatingSystem.current().isWindows() ? 'tcp://127.0.0.1:2375' : 'unix:///var/run/docker.sock'
}
task dockerfile(type: Copy) {
    from 'Dockerfile'
    into "$buildDir/libs/"
}

task dockerBuild(type: DockerBuildImage) {
    dependsOn dockerfile

    inputDir = project.file "$buildDir/libs"
    tag = "$image:$buildNumber"
}

task dockerPush(type: DockerPushImage) {
    imageName = image
//    tag = buildNumber
}
